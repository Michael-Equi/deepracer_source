<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Camera Tampering Detection: main.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="intellogo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Camera Tampering Detection
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">main.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">    Copyright 2018 Intel Corporation.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">    This software and the related documents are Intel copyrighted materials,</span></div><div class="line"><span class="comment">    and your use of them is governed by the express license under which they</span></div><div class="line"><span class="comment">    were provided to you (Intel Simplified Software License (Version April 2018))</span></div><div class="line"><span class="comment">    Unless the License provides otherwise, you may not use, modify,</span></div><div class="line"><span class="comment">    copy, publish, distribute, disclose or transmit this software or</span></div><div class="line"><span class="comment">    the related documents without Intel&#39;s prior written permission.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">    This software and the related documents are provided as is, with no</span></div><div class="line"><span class="comment">    express or implied warranties, other than those that are expressly</span></div><div class="line"><span class="comment">    stated in the License.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="ctd_8hpp.html">cva/ctd/ctd.hpp</a>&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;opencv2/core.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;opencv2/highgui.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;opencv2/imgproc.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;opencv2/videoio.hpp&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* kWindowName     = <span class="stringliteral">&quot;Camera tampering detection demo&quot;</span>;</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> kEscapeKey        = 27;</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">size_t</span> kFramesForInit = 100;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* kAbout = <span class="stringliteral">&quot;This is camera tampering detection example.\n&quot;</span>;</div><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* kOptions        =</div><div class="line">    <span class="stringliteral">&quot;{ h ? help usage |                   | print help message }&quot;</span></div><div class="line">    <span class="stringliteral">&quot;{@video          |                   | input video (if not specified then use camera device with id 0) }&quot;</span></div><div class="line">    <span class="stringliteral">&quot;{show-gui s      | false             | whether to show gui }&quot;</span></div><div class="line">    ;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> SetupParameters(<a name="_a0"></a><a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html">cva::ctd::CameraTamperingDetector</a> &amp;ct_detector) {</div><div class="line">  <span class="keywordflow">try</span> {</div><div class="line">    <span class="keywordtype">float</span> occlusion_area_ratio_threshold_estimation =</div><div class="line">        ct_detector.<a name="a1"></a><a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a7ce36e37f2a7db41faefe5fea4d7da8c">getParameterEstimation</a>(<a name="a2"></a><a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1a6d0e366ba0371ed256f85893550f5e22">cva::ctd::DetectorParameter::OCCLUSION_AREA_RATIO_THRESHOLD</a>);</div><div class="line">    <span class="keywordtype">float</span> occlusion_area_ratio_threshold = 0.45f;</div><div class="line">    occlusion_area_ratio_threshold = std::max(occlusion_area_ratio_threshold,</div><div class="line">                                              occlusion_area_ratio_threshold_estimation);</div><div class="line">    ct_detector.<a name="a3"></a><a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a39d992066390f2929000320f81097f8e">setFloatParameter</a>(<a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1a6d0e366ba0371ed256f85893550f5e22">cva::ctd::DetectorParameter::OCCLUSION_AREA_RATIO_THRESHOLD</a>,</div><div class="line">                                  occlusion_area_ratio_threshold);</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> occlusion_area_ratio_without_motion_threshold_estimation =</div><div class="line">        ct_detector.<a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a7ce36e37f2a7db41faefe5fea4d7da8c">getParameterEstimation</a>(<a name="a4"></a><a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1ade44fde54ab9c984e26aabe65575b75b">cva::ctd::DetectorParameter::OCCLUSION_AREA_RATIO_WITHOUT_MOTION_THRESHOLD</a>);</div><div class="line">    <span class="keywordtype">float</span> occlusion_area_ratio_without_motion_threshold = 0.3f;</div><div class="line">    occlusion_area_ratio_without_motion_threshold = std::max(occlusion_area_ratio_without_motion_threshold,</div><div class="line">                                                             occlusion_area_ratio_without_motion_threshold_estimation);</div><div class="line">    ct_detector.<a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a39d992066390f2929000320f81097f8e">setFloatParameter</a>(<a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1ade44fde54ab9c984e26aabe65575b75b">cva::ctd::DetectorParameter::OCCLUSION_AREA_RATIO_WITHOUT_MOTION_THRESHOLD</a>,</div><div class="line">                                  occlusion_area_ratio_without_motion_threshold);</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> defocus_ratio_threshold_estimation =</div><div class="line">        ct_detector.<a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a7ce36e37f2a7db41faefe5fea4d7da8c">getParameterEstimation</a>(<a name="a5"></a><a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1a4689f8d1d49b488a84627c1a556a3d66">cva::ctd::DetectorParameter::DEFOCUS_RATIO_THRESHOLD</a>);</div><div class="line">    <span class="keywordtype">float</span> defocus_ratio_threshold = 0.5f;</div><div class="line">    defocus_ratio_threshold = std::min(defocus_ratio_threshold, defocus_ratio_threshold_estimation);</div><div class="line">    ct_detector.<a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a39d992066390f2929000320f81097f8e">setFloatParameter</a>(<a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1a4689f8d1d49b488a84627c1a556a3d66">cva::ctd::DetectorParameter::DEFOCUS_RATIO_THRESHOLD</a>,</div><div class="line">                                  defocus_ratio_threshold);</div><div class="line"></div><div class="line">    <span class="keywordtype">float</span> displacement_ratio_threshold_estimation =</div><div class="line">        ct_detector.<a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a7ce36e37f2a7db41faefe5fea4d7da8c">getParameterEstimation</a>(<a name="a6"></a><a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1a75e1f224b856fd565eed0001698f2ddf">cva::ctd::DetectorParameter::DISPLACEMENT_RATIO_THRESHOLD</a>);</div><div class="line">    <span class="keywordtype">float</span> displacement_ratio_threshold = 0.5f;</div><div class="line">    displacement_ratio_threshold = std::max(displacement_ratio_threshold, displacement_ratio_threshold_estimation);</div><div class="line">    ct_detector.<a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a39d992066390f2929000320f81097f8e">setFloatParameter</a>(<a class="code" href="namespacecva_1_1ctd.html#a1934a41d6f9c7f17eb464fdc761952b1a75e1f224b856fd565eed0001698f2ddf">cva::ctd::DetectorParameter::DISPLACEMENT_RATIO_THRESHOLD</a>,</div><div class="line">                                  displacement_ratio_threshold);</div><div class="line">  } <span class="keywordflow">catch</span> (cv::Exception) {</div><div class="line">    std::cerr &lt;&lt; <span class="stringliteral">&quot;Something wrong with parameters configuration!&quot;</span> &lt;&lt; std::endl;</div><div class="line">    exit(-1);</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span>** argv) {</div><div class="line">  cv::CommandLineParser parser(argc, argv, kOptions);</div><div class="line">  parser.about(kAbout);</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (parser.has(<span class="stringliteral">&quot;help&quot;</span>)) {</div><div class="line">    parser.printMessage();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">  }</div><div class="line"></div><div class="line">  cv::String video_path = parser.get&lt;cv::String&gt;(<span class="stringliteral">&quot;@video&quot;</span>);</div><div class="line">  <span class="keywordflow">if</span> (!parser.check()) {</div><div class="line">    parser.printErrors();</div><div class="line">    <span class="keywordflow">return</span> -1;</div><div class="line">  }</div><div class="line"></div><div class="line">  cv::VideoCapture capture;</div><div class="line">  <span class="keywordflow">if</span> (video_path.empty()) {</div><div class="line">    capture.open(0);</div><div class="line">    <span class="keywordflow">if</span> (!capture.isOpened()) {</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Failed to open camera device&quot;</span> &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">  } <span class="keywordflow">else</span> {</div><div class="line">    capture.open(video_path);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (!capture.isOpened()) {</div><div class="line">      std::cout &lt;&lt; <span class="stringliteral">&quot;Failed to open video: &quot;</span> &lt;&lt; video_path &lt;&lt; std::endl;</div><div class="line">      <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordtype">bool</span> use_gui = parser.get&lt;<span class="keywordtype">bool</span>&gt;(<span class="stringliteral">&quot;show-gui&quot;</span>);</div><div class="line"></div><div class="line">  <span class="keywordflow">if</span> (use_gui) {</div><div class="line">    cv::namedWindow(kWindowName, cv::WINDOW_AUTOSIZE);</div><div class="line">    cv::moveWindow(kWindowName, 0, 0);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Create camera tampering detector</span></div><div class="line">  <span class="keyword">auto</span> ct_detector = <a name="a7"></a><a class="code" href="classcva_1_1ctd_1_1CameraTamperingDetector.html#a4d8e43493b54e63d38e089c3979ce542">cva::ctd::CameraTamperingDetector::create</a>();</div><div class="line"></div><div class="line">  cv::Mat frame;</div><div class="line">  capture &gt;&gt; frame;</div><div class="line">  <span class="keywordtype">size_t</span> frame_idx = 0;</div><div class="line">  <span class="keywordtype">bool</span> is_tampering = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="keywordflow">while</span> (!frame.empty()) {</div><div class="line">    <a class="code" href="namespacecva_1_1ctd.html#a3772f9c0ac55f12e86853e0079e687f5">cva::ctd::TamperingType</a> tampering_type = ct_detector-&gt;process(frame);</div><div class="line">    std::string state;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (frame_idx &lt; kFramesForInit) {  <span class="comment">// Collect data for parameters esimation</span></div><div class="line">      state = <span class="stringliteral">&quot;Waiting&quot;</span>;</div><div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame_idx == kFramesForInit) {  <span class="comment">// Estimate and setup parameters</span></div><div class="line">      state = <span class="stringliteral">&quot;Updating parameters&quot;</span>;</div><div class="line">      SetupParameters(*ct_detector);</div><div class="line">    } <span class="keywordflow">else</span> {  <span class="comment">// Process camera tampering events</span></div><div class="line">      <span class="keywordflow">switch</span> (tampering_type) {</div><div class="line">        <span class="keywordflow">case</span> <a name="a8"></a><a class="code" href="namespacecva_1_1ctd.html#a3772f9c0ac55f12e86853e0079e687f5afa241b164cd4589b2372ed15d9715b7d">cva::ctd::TAMPERING_INITIALIZING</a>: {</div><div class="line">          state = <span class="stringliteral">&quot;INITIALIZING&quot;</span>;</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">case</span> <a name="a9"></a><a class="code" href="namespacecva_1_1ctd.html#a3772f9c0ac55f12e86853e0079e687f5a144171343de34c6f0e7d31794b0413e6">cva::ctd::TAMPERING_NONE</a>: {</div><div class="line">          state = <span class="stringliteral">&quot;OK&quot;</span>;</div><div class="line">          <span class="keywordflow">if</span> (is_tampering) {  <span class="comment">// Reset after Tampering event (Occlusion or Defocus only)</span></div><div class="line">            is_tampering = <span class="keyword">false</span>;</div><div class="line">            ct_detector-&gt;reset();</div><div class="line">            frame_idx = 0;</div><div class="line">          }</div><div class="line">          <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">default</span>: {</div><div class="line">          is_tampering = <span class="keyword">true</span>;</div><div class="line">          <span class="keywordflow">if</span> (tampering_type &amp; <a name="a10"></a><a class="code" href="namespacecva_1_1ctd.html#a3772f9c0ac55f12e86853e0079e687f5a6e92630ccfedaf9e4b426573eea9e9ab">cva::ctd::TAMPERING_DEFOCUS</a>)</div><div class="line">            state += <span class="stringliteral">&quot;|DEFOCUS|&quot;</span>;</div><div class="line">          <span class="keywordflow">if</span> (tampering_type &amp; <a name="a11"></a><a class="code" href="namespacecva_1_1ctd.html#a3772f9c0ac55f12e86853e0079e687f5aa0b7f5868efa65ca8fe43a81d507f060">cva::ctd::TAMPERING_OCCLUSION</a>)</div><div class="line">            state += <span class="stringliteral">&quot;|OCCLUSION|&quot;</span>;</div><div class="line">          <span class="keywordflow">if</span> (tampering_type &amp; <a name="a12"></a><a class="code" href="namespacecva_1_1ctd.html#a3772f9c0ac55f12e86853e0079e687f5a4667f0c6808cf94089daab0639c0d99f">cva::ctd::TAMPERING_DISPLACEMENT</a>)</div><div class="line">            state += <span class="stringliteral">&quot;|DISPLACEMENT|&quot;</span>;</div><div class="line">        }</div><div class="line">      };</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>         font_face          = cv::FONT_HERSHEY_COMPLEX;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span>      font_scale         = 1.;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span>         font_thickness     = 2;</div><div class="line">    <span class="keyword">const</span> cv::Scalar  foreground_color   = cv::Scalar(0, 0, 255);</div><div class="line">    cv::putText(frame, state, cv::Point(10, 30), font_face, font_scale, foreground_color, font_thickness);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (use_gui) {</div><div class="line">      cv::imshow(kWindowName, frame);</div><div class="line"></div><div class="line">      <span class="keywordtype">int</span> key = cv::waitKey(10) &amp; 0x00FF;</div><div class="line">      <span class="keywordflow">if</span> (key == kEscapeKey) {</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">      }</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">      std::stringstream ss;</div><div class="line">      ss &lt;&lt; std::setw(6) &lt;&lt; std::setfill(<span class="charliteral">&#39;0&#39;</span>) &lt;&lt; frame_idx;</div><div class="line">      cv::imwrite(ss.str() + <span class="stringliteral">&quot;.png&quot;</span>, frame);</div><div class="line">    }</div><div class="line"></div><div class="line">    capture &gt;&gt; frame;</div><div class="line">    ++frame_idx;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Dec 4 2018 16:49:51 for Camera Tampering Detection by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
